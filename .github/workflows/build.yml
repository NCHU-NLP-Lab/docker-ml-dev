name: Build and Publish

on:
  push:
    branches:
      - "main"
    paths-ignore:
      - "*.md"
  pull_request:
    branches:
      - "main"
  schedule:
    - cron: "0 0 1 * *"
  workflow_dispatch:

jobs:
  build:
    name: "Build"
    runs-on: "ubuntu-latest"
    strategy:
      fail-fast: false
      matrix:
        image:
          - "cu11.2-py38-tf2.11.0-torch1.9.1-jupyterlab-vscode"
          - "cu11.6-py38-tf2.10.0-torch1.12.1-jupyterlab-vscode"
          - "cu11.6-py39-torch1.12.1-jupyterlab-vscode"
          - "cu11.8-py310-torch2.0.0-jupyterlab-vscode"
          - "cu11.8-py310-torch2.0.1-jupyterlab-vscode"
    steps:
      - uses: "actions/checkout@v2"

      - name: "Docker login"
        uses: "docker/login-action@v1"
        with:
          username: "nchunlplab"
          password: "${{ secrets.DOCKER_PASSWORD }}"

      - name: "Build and push"
        uses: "docker/build-push-action@v2"
        with:
          context: "image"
          file: "image/${{ matrix.image }}.Dockerfile"
          tags: "nchunlplab/ml-dev:${{ matrix.image }}"
          push: true
